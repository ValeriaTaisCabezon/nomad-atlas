<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nomad Atlas - Tu Diario de Viajes</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #d4a574; --secondary: #2a5a4a; --accent: #e85d75; --dark: #1a1a1a; --light: #f8f5f0; --border: #d4c5b0; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Work Sans', sans-serif; background: var(--light); color: var(--dark); overflow-x: hidden; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; font-weight: 900; }
        
        .header { background: linear-gradient(135deg, var(--secondary) 0%, #1e4339 100%); color: white; padding: 2rem; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo { font-size: 2rem; font-weight: 900; }
        .nav-tabs { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .nav-tab { padding: 0.75rem 1.5rem; background: rgba(255,255,255,0.1); border: none; color: white; cursor: pointer; border-radius: 8px; font-weight: 500; transition: all 0.3s; }
        .nav-tab:hover:not(:disabled) { background: rgba(255,255,255,0.2); transform: translateY(-2px); }
        .nav-tab.active { background: var(--primary); color: var(--dark); }
        .nav-tab:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .main-content { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        
        .profile-section { background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 2rem; border: 2px solid var(--border); }
        .profile-header { display: flex; align-items: center; gap: 2rem; flex-wrap: wrap; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, var(--primary) 0%, #c89456 100%); display: flex; align-items: center; justify-content: center; font-size: 3rem; color: white; }
        .profile-info h2 { font-size: 2rem; color: var(--secondary); margin-bottom: 0.5rem; }
        
        .map-container { height: 70vh; border-radius: 16px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.12); margin-bottom: 2rem; }
        #map { height: 100%; width: 100%; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 2rem; overflow-y: auto; }
        .modal-content { background: white; border-radius: 20px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-header { padding: 2rem; border-bottom: 2px solid var(--border); position: sticky; top: 0; background: white; z-index: 10; }
        .modal-close { position: absolute; top: 1.5rem; right: 1.5rem; background: var(--light); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; transition: all 0.3s; }
        .modal-close:hover { background: var(--primary); color: white; transform: rotate(90deg); }
        .modal-body { padding: 2rem; }
        .trip-detail-title { font-size: 2.5rem; color: var(--secondary); margin-bottom: 1rem; }
        .trip-detail-meta { display: flex; gap: 2rem; flex-wrap: wrap; margin-bottom: 2rem; }
        .trip-detail-meta-item { display: flex; align-items: center; gap: 0.5rem; }
        .trip-detail-map { height: 400px; border-radius: 12px; overflow: hidden; margin-bottom: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .add-trip-section { background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 2rem; border: 2px solid var(--border); }
        .form-title { font-size: 1.8rem; margin-bottom: 1.5rem; color: var(--secondary); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .form-section { margin-bottom: 2rem; padding: 1.5rem; background: var(--light); border-radius: 12px; }
        .form-section-title { font-size: 1.2rem; margin-bottom: 1rem; color: var(--secondary); font-weight: 600; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 0.5rem; color: var(--secondary); font-size: 0.9rem; text-transform: uppercase; }
        input, textarea, select { padding: 0.875rem; border: 2px solid var(--border); border-radius: 8px; font-family: 'Work Sans', sans-serif; font-size: 1rem; transition: all 0.3s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(212,165,116,0.1); }
        textarea { min-height: 100px; resize: vertical; }
        
        .people-container { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
        .person-tag { background: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .person-avatar { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; border: 2px solid white; }
        .person-tag button { background: rgba(255,255,255,0.3); border: none; width: 20px; height: 20px; border-radius: 50%; color: white; cursor: pointer; font-weight: bold; }
        .suggested-people { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
        .suggested-person { background: var(--light); padding: 0.5rem 1rem; border: 2px solid var(--border); border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; display: flex; align-items: center; gap: 0.5rem; }
        .suggested-person:hover { background: var(--primary); color: white; border-color: var(--primary); }
        
        .destinations-list { display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem; }
        .destination-item { background: white; padding: 1.5rem; border-radius: 12px; border: 2px solid var(--border); position: relative; }
        .destination-item h4 { font-size: 1.1rem; color: var(--secondary); margin-bottom: 1rem; }
        .btn-remove { position: absolute; top: 1rem; right: 1rem; background: #dc3545; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .btn-remove:hover { background: #c82333; transform: scale(1.1); }
        .btn-edit-destino { background: var(--secondary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.85rem; cursor: pointer; margin-top: 0.5rem; }
        .btn-edit-destino:hover { background: #1e4339; }
        
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, #c89456 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-transform: uppercase; box-shadow: 0 4px 15px rgba(212,165,116,0.3); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,165,116,0.4); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-secondary { background: var(--secondary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-secondary:hover { background: #1e4339; transform: translateY(-2px); }
        .btn-edit { background: white; color: var(--secondary); border: 2px solid var(--border); padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-edit:hover { border-color: var(--primary); background: var(--light); }
        
        .file-input-wrapper { position: relative; overflow: hidden; width: 100%; }
        .file-input-wrapper input[type=file] { position: absolute; left: -9999px; }
        .file-input-label { display: flex; align-items: center; justify-content: center; padding: 0.875rem; background: var(--light); border: 2px dashed var(--border); border-radius: 8px; cursor: pointer; transition: all 0.3s; font-weight: 500; color: var(--secondary); }
        .file-input-label:hover { border-color: var(--primary); background: white; }
        .image-preview { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-top: 1rem; }
        
        .timeline-year-container { margin-bottom: 4rem; background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .timeline-year-header { font-size: 2.5rem; color: var(--primary); margin-bottom: 2rem; text-align: center; }
        .timeline-horizontal { position: relative; padding: 3rem 0; }
        .timeline-line { position: absolute; top: 50%; left: 0; right: 0; height: 4px; background: var(--border); transform: translateY(-50%); }
        .timeline-months { display: flex; justify-content: space-between; position: relative; }
        .timeline-month { flex: 1; text-align: center; position: relative; }
        .timeline-month-dot { width: 16px; height: 16px; background: var(--primary); border-radius: 50%; margin: 0 auto 0.5rem; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2); position: relative; z-index: 2; }
        .timeline-month-label { font-size: 0.85rem; font-weight: 600; color: var(--secondary); margin-bottom: 1rem; }
        .timeline-month-trips { display: flex; flex-direction: column; gap: 0.75rem; align-items: center; }
        .timeline-trip-mini { background: white; border: 2px solid var(--border); border-radius: 8px; padding: 0.5rem; min-width: 80px; max-width: 120px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .timeline-trip-mini:hover { transform: scale(1.1); border-color: var(--primary); box-shadow: 0 4px 16px rgba(0,0,0,0.15); z-index: 10; }
        .timeline-trip-mini-image { width: 100%; height: 50px; object-fit: cover; border-radius: 4px; margin-bottom: 0.35rem; }
        .timeline-trip-mini-title { font-size: 0.7rem; font-weight: 700; color: var(--secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-bottom: 0.25rem; }
        .timeline-trip-mini-meta { font-size: 0.65rem; color: #888; display: flex; align-items: center; justify-content: center; gap: 0.25rem; }
        
        .dashboard-section { margin-bottom: 3rem; }
        .dashboard-section-title { font-size: 2rem; color: var(--secondary); margin-bottom: 2rem; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .metric-card { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 2px solid var(--border); transition: all 0.3s; }
        .metric-card:hover { transform: translateY(-5px); box-shadow: 0 8px 30px rgba(0,0,0,0.12); border-color: var(--primary); }
        .metric-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.8; }
        .metric-value { font-size: 3.5rem; font-weight: 900; color: var(--primary); font-family: 'Playfair Display', serif; margin-bottom: 0.5rem; }
        .metric-label { font-size: 0.85rem; color: #666; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .metric-detail { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); font-size: 0.85rem; color: var(--secondary); }
        
        .top-destinations-row { display: flex; gap: 1.5rem; overflow-x: auto; padding: 1rem 0; }
        .top-dest-card { background: white; padding: 2rem 1.5rem; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 2px solid var(--border); min-width: 220px; flex-shrink: 0; text-align: center; transition: all 0.3s; }
        .top-dest-card:hover { transform: translateY(-5px); box-shadow: 0 8px 30px rgba(0,0,0,0.12); border-color: var(--primary); }
        .top-dest-name { font-size: 1.6rem; font-weight: 700; color: var(--secondary); margin-bottom: 1rem; }
        .top-dest-count { font-size: 3rem; font-weight: 900; color: var(--primary); font-family: 'Playfair Display', serif; }
        .top-dest-label { font-size: 0.8rem; color: #888; text-transform: uppercase; margin-top: 0.5rem; }
        
        .people-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }
        .person-metric-card { background: white; padding: 1.5rem; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 2px solid var(--border); transition: all 0.3s; }
        .person-metric-card:hover { transform: translateY(-5px); box-shadow: 0 8px 30px rgba(0,0,0,0.12); border-color: var(--primary); }
        .person-metric-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .person-metric-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); flex-shrink: 0; }
        .person-metric-info { flex: 1; }
        .person-metric-name { font-size: 1.3rem; font-weight: 700; color: var(--secondary); margin-bottom: 0.25rem; }
        .person-metric-main { font-size: 1.8rem; font-weight: 900; color: var(--primary); font-family: 'Playfair Display', serif; }
        .person-metric-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .person-metric-stat { background: var(--light); padding: 1rem; border-radius: 12px; text-align: center; }
        .person-metric-stat-value { font-size: 1.5rem; font-weight: 700; color: var(--secondary); margin-bottom: 0.25rem; }
        .person-metric-stat-label { font-size: 0.75rem; color: #666; text-transform: uppercase; }
        
        .wrapped-container { max-height: 85vh; overflow-y: auto; }
        .wrapped-gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1.25rem; }
        .wrapped-card { background: linear-gradient(135deg, var(--secondary) 0%, #1e4339 100%); color: white; border-radius: 14px; padding: 1.5rem; position: relative; overflow: hidden; min-height: 160px; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 4px 20px rgba(0,0,0,0.12); transition: all 0.3s; }
        .wrapped-card:hover { transform: translateY(-3px); box-shadow: 0 6px 25px rgba(0,0,0,0.15); }
        .wrapped-card-icon { font-size: 2.5rem; margin-bottom: 0.75rem; opacity: 0.9; }
        .wrapped-card-value { font-size: 2.5rem; font-weight: 900; color: var(--primary); font-family: 'Playfair Display', serif; margin-bottom: 0.25rem; line-height: 1; }
        .wrapped-card-label { font-size: 0.95rem; opacity: 0.9; margin-bottom: 0.35rem; }
        .wrapped-card-detail { font-size: 0.75rem; opacity: 0.75; }
        .wrapped-places-card { grid-column: 1 / -1; max-height: 200px; }
        .wrapped-places-grid { display: flex; flex-wrap: wrap; gap: 0.45rem; margin-top: 0.75rem; max-height: 100px; overflow-y: auto; }
        .wrapped-place-tag { background: var(--primary); color: var(--dark); padding: 0.3rem 0.7rem; border-radius: 14px; font-weight: 600; font-size: 0.75rem; }
        
        .trips-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .trip-list-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: all 0.3s; border: 2px solid var(--border); }
        .trip-list-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); border-color: var(--primary); }
        .trip-list-card-image { width: 100%; height: 200px; object-fit: cover; cursor: pointer; }
        .trip-list-card-content { padding: 1.5rem; cursor: pointer; }
        .trip-list-card-title { font-size: 1.4rem; color: var(--secondary); margin-bottom: 0.75rem; font-weight: 700; }
        .trip-list-card-date { color: #666; font-size: 0.9rem; margin-bottom: 1rem; }
        .trip-list-card-meta { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
        .trip-list-card-meta-item { display: flex; align-items: center; gap: 0.35rem; font-size: 0.85rem; color: #888; }
        
        .empty-state { text-align: center; padding: 4rem 2rem; color: #999; }
        .empty-state-icon { font-size: 5rem; margin-bottom: 1rem; opacity: 0.3; }
        .empty-state-text { font-size: 1.2rem; }
        
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .csv-import { margin-top: 1rem; padding: 1.5rem; background: var(--light); border-radius: 12px; border: 2px dashed var(--border); }
        .csv-import h4 { font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--secondary); }
        .csv-help { font-size: 0.85rem; color: #666; margin-bottom: 0.75rem; line-height: 1.4; }
        .csv-example { font-size: 0.8rem; font-family: monospace; background: white; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; overflow-x: auto; }
        
        .toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 3000; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { padding: 1rem 1.5rem; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease; max-width: 400px; font-size: 0.95rem; }
        .toast-success { background: #2a5a4a; }
        .toast-error { background: #dc3545; }
        .toast-warning { background: #e89a3c; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .csv-preview-table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.85rem; }
        .csv-preview-table th, .csv-preview-table td { padding: 0.5rem 0.75rem; border: 1px solid var(--border); text-align: left; }
        .csv-preview-table th { background: var(--secondary); color: white; font-weight: 600; }
        .csv-preview-table tr:nth-child(even) { background: var(--light); }
        .csv-preview-table tr.duplicate { background: #fff3cd; }
        .csv-progress-bar { width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin: 1rem 0; }
        .csv-progress-fill { height: 100%; background: var(--secondary); border-radius: 4px; transition: width 0.3s; }

        .year-selector-bar { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 2rem; padding: 1rem 1.5rem; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); border: 2px solid var(--border); flex-wrap: wrap; }
        .year-chip { padding: 0.5rem 1.25rem; border-radius: 20px; border: 2px solid var(--border); background: white; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.3s; color: var(--dark); }
        .year-chip:hover { border-color: var(--primary); background: var(--light); }
        .year-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        .dashboard-bar-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
        .dashboard-bar-label { min-width: 80px; font-size: 0.85rem; font-weight: 600; color: var(--secondary); text-align: right; }
        .dashboard-bar-track { flex: 1; height: 24px; background: var(--light); border-radius: 12px; overflow: hidden; }
        .dashboard-bar-fill { height: 100%; background: linear-gradient(135deg, var(--primary) 0%, #c89456 100%); border-radius: 12px; transition: width 0.5s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 0.5rem; min-width: 24px; }
        .dashboard-bar-value { font-size: 0.75rem; font-weight: 700; color: white; }
        .dashboard-bar-count { min-width: 30px; font-size: 0.85rem; font-weight: 700; color: var(--secondary); text-align: left; }
        .dashboard-mini-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
        .dashboard-mini-card { background: var(--light); padding: 1.25rem; border-radius: 12px; text-align: center; }
        .dashboard-mini-value { font-size: 2rem; font-weight: 900; color: var(--primary); font-family: 'Playfair Display', serif; }
        .dashboard-mini-label { font-size: 0.8rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 0.25rem; }

        @media (max-width: 768px) {
            .header-content { flex-direction: column; text-align: center; }
            .form-grid { grid-template-columns: 1fr; }
            .wrapped-card-value { font-size: 2rem; }
            .timeline-months { flex-direction: column; gap: 2rem; }
            .timeline-line { display: none; }
            .top-destinations-row { flex-direction: column; }
            .top-dest-card { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const geocodeQueue = { lastCall: 0 };
        const geocodePlace = async (place) => {
            const now = Date.now();
            const timeSinceLast = now - geocodeQueue.lastCall;
            if (timeSinceLast < 1100) {
                await new Promise(resolve => setTimeout(resolve, 1100 - timeSinceLast));
            }
            geocodeQueue.lastCall = Date.now();
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}&limit=1`);
                const data = await response.json();
                if (data.length > 0) return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
            } catch (error) { console.error('Geocoding error:', error); }
            return null;
        };

        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        };

        const getMotivoEmoji = (motivo) => {
            const emojis = { 'placer': 'üèñÔ∏è', 'negocios': 'üíº', 'evento': 'üéâ', 'familia': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', 'estudio': 'üìö', 'otro': 'üåü' };
            return emojis[motivo] || '‚úàÔ∏è';
        };

        const compressImage = (dataUrl, maxWidth = 800, quality = 0.6) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = () => resolve(dataUrl);
                img.src = dataUrl;
            });
        };

        const formatDateRange = (startDate, endDate) => {
            if (!startDate) return '';
            const opts = { day: 'numeric', month: 'short' };
            const optsYear = { day: 'numeric', month: 'short', year: 'numeric' };
            const s = new Date(startDate + 'T12:00:00');
            if (!endDate || endDate === startDate) return s.toLocaleDateString('es-ES', optsYear);
            const e = new Date(endDate + 'T12:00:00');
            if (s.getFullYear() === e.getFullYear()) {
                return s.toLocaleDateString('es-ES', opts) + ' - ' + e.toLocaleDateString('es-ES', optsYear);
            }
            return s.toLocaleDateString('es-ES', optsYear) + ' - ' + e.toLocaleDateString('es-ES', optsYear);
        };

        const safeSetItem = (key, value, showToast) => {
            try { localStorage.setItem(key, value); }
            catch (e) { if (showToast) showToast('Almacenamiento lleno. Intenta eliminar fotos de algunos viajes.', 'error'); console.error('localStorage quota exceeded:', e); }
        };

        const ToastContainer = ({ toasts }) => (
            <div className="toast-container">
                {toasts.map(t => (
                    <div key={t.id} className={`toast toast-${t.type}`}>{t.message}</div>
                ))}
            </div>
        );

        const ConfirmDialog = ({ isOpen, title, message, onConfirm, onCancel, confirmText, cancelText, danger }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay" onClick={onCancel}>
                    <div style={{background: 'white', borderRadius: '16px', padding: '2rem', maxWidth: '450px', width: '100%'}} onClick={e => e.stopPropagation()}>
                        <h3 style={{marginBottom: '1rem', color: 'var(--secondary)'}}>{title}</h3>
                        <p style={{marginBottom: '1.5rem', color: '#666', lineHeight: '1.5'}}>{message}</p>
                        <div style={{display: 'flex', gap: '1rem', justifyContent: 'flex-end'}}>
                            <button className="btn-edit" onClick={onCancel}>{cancelText || 'Cancelar'}</button>
                            <button className="btn-primary" style={danger ? {background: '#dc3545'} : {}} onClick={onConfirm}>{confirmText || 'Confirmar'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const parseCSVField = (text) => {
            const fields = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') {
                    if (inQuotes && text[i + 1] === '"') { current += '"'; i++; }
                    else { inQuotes = !inQuotes; }
                } else if (char === ',' && !inQuotes) {
                    fields.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            fields.push(current.trim());
            return fields;
        };

        const parseCSVRows = (text) => {
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length < 2) return { trips: [], errors: [{ row: 0, message: 'El archivo esta vacio o no tiene datos' }] };
            const errors = [];
            const headerFields = parseCSVField(lines[0]);
            const headerLower = headerFields.map(h => h.toLowerCase().replace(/\s+/g, ''));
            const colMap = {};
            headerLower.forEach((h, i) => { colMap[h] = i; });
            const getCol = (row, ...names) => {
                for (const name of names) {
                    if (colMap[name] !== undefined && row[colMap[name]] !== undefined) return row[colMap[name]].trim();
                }
                return '';
            };
            const rawEntries = [];
            for (let i = 1; i < lines.length; i++) {
                try {
                    const values = parseCSVField(lines[i]);
                    if (values.length < 4) { errors.push({ row: i + 1, message: 'Muy pocas columnas' }); continue; }
                    const tripId = getCol(values, 'tripid') || null;
                    const fechaInicio = getCol(values, 'tripfechainicio', 'fechainicio');
                    const fechaFinal = getCol(values, 'tripfechafinal', 'fechafinal') || fechaInicio;
                    const motivo = getCol(values, 'motivo') || 'placer';
                    const personas = getCol(values, 'personas');
                    const notas = getCol(values, 'notas') || '';
                    const lugar = getCol(values, 'lugar');
                    const destFechaInicio = getCol(values, 'destfechainicio', 'destinofechainicio') || fechaInicio;
                    const destFechaFinal = getCol(values, 'destfechafinal', 'destinofechafinal') || fechaFinal;
                    if (!fechaInicio) { errors.push({ row: i + 1, message: 'Falta fecha de inicio' }); continue; }
                    if (!lugar) { errors.push({ row: i + 1, message: 'Falta lugar/destino' }); continue; }
                    rawEntries.push({ tripId, fechaInicio, fechaFinal, motivo, personas: personas ? personas.split(';').map(n => ({ nombre: n.trim(), foto: null })).filter(p => p.nombre) : [], notas, lugar, destFechaInicio, destFechaFinal, sourceRow: i + 1 });
                } catch (e) { errors.push({ row: i + 1, message: 'Error de parseo: ' + e.message }); }
            }
            const tripMap = new Map();
            rawEntries.forEach(entry => {
                const groupKey = entry.tripId || entry.fechaInicio;
                if (!tripMap.has(groupKey)) {
                    tripMap.set(groupKey, { id: Date.now() + Math.floor(Math.random() * 10000), fechaInicio: entry.fechaInicio, fechaFinal: entry.fechaFinal, motivo: entry.motivo, personas: entry.personas, destinos: [], notas: entry.notas, createdAt: new Date().toISOString() });
                }
                const trip = tripMap.get(groupKey);
                trip.destinos.push({ lugar: entry.lugar, fechaInicio: entry.destFechaInicio, fechaFinal: entry.destFechaFinal, foto: null, coordinates: null });
                if (entry.notas && trip.notas && !trip.notas.includes(entry.notas)) { trip.notas = trip.notas + '; ' + entry.notas; }
                else if (entry.notas && !trip.notas) { trip.notas = entry.notas; }
            });
            return { trips: [...tripMap.values()], errors };
        };

        const geocodeTrips = async (trips, onProgress) => {
            const errors = [];
            let geocoded = 0;
            const totalDestinations = trips.reduce((sum, t) => sum + t.destinos.length, 0);
            for (const trip of trips) {
                for (const destino of trip.destinos) {
                    if (!destino.coordinates) {
                        try {
                            destino.coordinates = await geocodePlace(destino.lugar);
                            if (!destino.coordinates) errors.push({ lugar: destino.lugar, message: 'No se encontraron coordenadas' });
                        } catch (e) { errors.push({ lugar: destino.lugar, message: e.message }); }
                    }
                    geocoded++;
                    if (onProgress) onProgress(geocoded, totalDestinations);
                }
            }
            return { trips, errors };
        };

        const detectDuplicates = (newTrips, existingTrips) => {
            return newTrips.map(newTrip => {
                const isDuplicate = existingTrips.some(existing =>
                    existing.fechaInicio === newTrip.fechaInicio &&
                    existing.fechaFinal === newTrip.fechaFinal &&
                    existing.destinos.length === newTrip.destinos.length &&
                    existing.destinos.every((d, i) => d.lugar === newTrip.destinos[i]?.lugar)
                );
                return { ...newTrip, _isDuplicate: isDuplicate };
            });
        };

        const ProfileView = ({ profile, onUpdateProfile }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [formData, setFormData] = useState(profile || { nombre: '', ubicacion: '', emoji: 'üåç' });

            const handleSubmit = (e) => {
                e.preventDefault();
                onUpdateProfile(formData);
                setIsEditing(false);
            };

            if (!profile && !isEditing) {
                return (
                    <div className="profile-section">
                        <div className="empty-state">
                            <div className="empty-state-icon">üë§</div>
                            <div className="empty-state-text">Crea tu perfil para comenzar</div>
                            <button className="btn-primary" onClick={() => setIsEditing(true)} style={{marginTop: '1rem'}}>Crear Perfil</button>
                        </div>
                    </div>
                );
            }

            if (isEditing) {
                return (
                    <div className="profile-section">
                        <h2 className="form-title">Tu Perfil</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="form-grid">
                                <div className="form-group"><label>Nombre</label><input type="text" value={formData.nombre} onChange={(e) => setFormData({...formData, nombre: e.target.value})} required /></div>
                                <div className="form-group"><label>Ciudad de origen</label><input type="text" value={formData.ubicacion} onChange={(e) => setFormData({...formData, ubicacion: e.target.value})} placeholder="Buenos Aires, Argentina" required /></div>
                                <div className="form-group"><label>Emoji favorito</label><input type="text" value={formData.emoji} onChange={(e) => setFormData({...formData, emoji: e.target.value})} maxLength="2" /></div>
                            </div>
                            <div style={{display: 'flex', gap: '1rem', marginTop: '1rem'}}>
                                <button type="submit" className="btn-primary">Guardar</button>
                                {profile && <button type="button" className="btn-secondary" onClick={() => setIsEditing(false)}>Cancelar</button>}
                            </div>
                        </form>
                    </div>
                );
            }

            return (
                <div className="profile-section">
                    <div className="profile-header">
                        <div className="profile-avatar">{profile.emoji}</div>
                        <div className="profile-info">
                            <h2>{profile.nombre}</h2>
                            <div>üìç {profile.ubicacion}</div>
                        </div>
                        <button className="btn-secondary" onClick={() => setIsEditing(true)}>Editar Perfil</button>
                    </div>
                </div>
            );
        };

        const TripCard = ({ trip, onClick, showEditButton, onEdit, onDelete }) => {
            const firstDestino = trip.destinos[0];
            const duracion = trip.fechaFinal ? Math.ceil((new Date(trip.fechaFinal) - new Date(trip.fechaInicio)) / (1000 * 60 * 60 * 24)) : 1;
            
            return (
                <div className="trip-list-card">
                    <div onClick={onClick}>
                        {firstDestino?.foto && <img src={firstDestino.foto} alt={firstDestino.lugar} className="trip-list-card-image" />}
                        <div className="trip-list-card-content">
                            <h3 className="trip-list-card-title">{trip.destinos.map(d => d.lugar).join(' ‚Üí ')}</h3>
                            <div className="trip-list-card-date">{formatDateRange(trip.fechaInicio, trip.fechaFinal)}</div>
                            <div className="trip-list-card-meta">
                                <div className="trip-list-card-meta-item"><span>{getMotivoEmoji(trip.motivo)}</span><span>{trip.motivo}</span></div>
                                <div className="trip-list-card-meta-item"><span>‚è±Ô∏è</span><span>{duracion}d</span></div>
                                <div className="trip-list-card-meta-item"><span>üìç</span><span>{trip.destinos.length}</span></div>
                                {trip.personas.length > 0 && <div className="trip-list-card-meta-item"><span>üë•</span><span>{trip.personas.length}</span></div>}
                            </div>
                        </div>
                    </div>
                    {showEditButton && (
                        <div style={{padding: '0 1.5rem 1.5rem', display: 'flex', gap: '0.5rem'}}>
                            <button className="btn-edit" onClick={(e) => { e.stopPropagation(); onEdit(trip); }} style={{flex: 1}}>‚úèÔ∏è Editar</button>
                            {onDelete && <button className="btn-edit" onClick={(e) => { e.stopPropagation(); onDelete(trip.id); }} style={{color: '#dc3545', borderColor: '#dc3545'}}>üóëÔ∏è Eliminar</button>}
                        </div>
                    )}
                </div>
            );
        };

        const MapView = ({ trips, homeCoords, onTripClick }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);

            useEffect(() => {
                if (!mapRef.current || mapInstanceRef.current) return;
                const map = L.map(mapRef.current).setView([20, 0], 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
                mapInstanceRef.current = map;
                return () => { if (mapInstanceRef.current) { mapInstanceRef.current.remove(); mapInstanceRef.current = null; } };
            }, []);

            useEffect(() => {
                if (!mapInstanceRef.current) return;
                mapInstanceRef.current.eachLayer(layer => { if (layer instanceof L.Marker) mapInstanceRef.current.removeLayer(layer); });
                const bounds = [];
                
                if (homeCoords) {
                    const homeMarker = L.marker([homeCoords.lat, homeCoords.lng], {
                        icon: L.divIcon({
                            className: '',
                            html: '<div style="width:40px;height:40px;border-radius:50%;border:3px solid white;box-shadow:0 4px 12px rgba(0,0,0,0.3);background-color:#2a5a4a;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:1.2rem;">üè†</div>',
                            iconSize: [40, 40],
                            iconAnchor: [20, 20]
                        })
                    }).addTo(mapInstanceRef.current);
                    homeMarker.bindPopup('<b>üè† Tu casa</b>');
                    bounds.push([homeCoords.lat, homeCoords.lng]);
                }
                
                trips.forEach(trip => {
                    const firstDestino = trip.destinos[0];
                    if (firstDestino?.coordinates) {
                        const markerHtml = `<div style="width:40px;height:40px;border-radius:50%;border:3px solid white;box-shadow:0 4px 12px rgba(0,0,0,0.3);background-size:cover;background-position:center;${firstDestino.foto ? `background-image:url(${firstDestino.foto});` : 'background-color:#e85d75;'}display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:1.2rem;cursor:pointer;">${!firstDestino.foto ? 'üìç' : ''}</div>`;
                        
                        const marker = L.marker([firstDestino.coordinates.lat, firstDestino.coordinates.lng], {
                            icon: L.divIcon({ className: '', html: markerHtml, iconSize: [40, 40], iconAnchor: [20, 20] })
                        }).addTo(mapInstanceRef.current);
                        
                        marker.on('click', () => onTripClick(trip));
                        marker.bindPopup(`<b>${trip.destinos.map(d => d.lugar).join(' ‚Üí ')}</b><br>${getMotivoEmoji(trip.motivo)} ${trip.motivo}`);
                        bounds.push([firstDestino.coordinates.lat, firstDestino.coordinates.lng]);
                    }
                });
                
                if (bounds.length > 0) mapInstanceRef.current.fitBounds(bounds, { padding: [50, 50] });
            }, [trips, homeCoords, onTripClick]);

            return <div id="map" ref={mapRef}></div>;
        };

        const TripDetailModal = ({ trip, onClose, homeCoords, onDelete, onEdit }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);

            useEffect(() => {
                if (!mapRef.current || mapInstanceRef.current) return;
                const map = L.map(mapRef.current).setView([20, 0], 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
                mapInstanceRef.current = map;
                const bounds = [];
                const coords = [];
                
                if (homeCoords) {
                    L.marker([homeCoords.lat, homeCoords.lng]).addTo(map).bindPopup('<b>üè† Origen</b>');
                    bounds.push([homeCoords.lat, homeCoords.lng]);
                    coords.push([homeCoords.lat, homeCoords.lng]);
                }
                
                trip.destinos.forEach(destino => {
                    if (destino.coordinates) {
                        L.marker([destino.coordinates.lat, destino.coordinates.lng]).addTo(map).bindPopup(`<b>${destino.lugar}</b>`);
                        bounds.push([destino.coordinates.lat, destino.coordinates.lng]);
                        coords.push([destino.coordinates.lat, destino.coordinates.lng]);
                    }
                });
                
                if (homeCoords) coords.push([homeCoords.lat, homeCoords.lng]);
                if (coords.length > 1) L.polyline(coords, { color: '#d4a574', weight: 3, opacity: 0.7, dashArray: '10, 10' }).addTo(map);
                if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
                return () => { if (mapInstanceRef.current) { mapInstanceRef.current.remove(); mapInstanceRef.current = null; } };
            }, [trip, homeCoords]);

            const duracion = trip.fechaFinal ? Math.ceil((new Date(trip.fechaFinal) - new Date(trip.fechaInicio)) / (1000 * 60 * 60 * 24)) : 1;

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        <div className="modal-body">
                            <h2 className="trip-detail-title">{trip.destinos.map(d => d.lugar).join(' ‚Üí ')}</h2>
                            <div className="trip-detail-meta">
                                <div className="trip-detail-meta-item"><span>üìÖ</span><span>{formatDateRange(trip.fechaInicio, trip.fechaFinal)}</span></div>
                                <div className="trip-detail-meta-item"><span>{getMotivoEmoji(trip.motivo)}</span><span>{trip.motivo}</span></div>
                                <div className="trip-detail-meta-item"><span>‚è±Ô∏è</span><span>{duracion} d√≠a{duracion !== 1 ? 's' : ''}</span></div>
                                <div className="trip-detail-meta-item"><span>üìç</span><span>{trip.destinos.length} destino{trip.destinos.length !== 1 ? 's' : ''}</span></div>
                            </div>
                            {trip.personas && trip.personas.length > 0 && (
                                <div style={{marginBottom: '2rem'}}>
                                    <h3 style={{fontSize: '1.2rem', marginBottom: '1rem', color: 'var(--secondary)'}}>üë• Acompa√±antes</h3>
                                    <div className="people-container">
                                        {trip.personas.map(person => (
                                            <div key={person.nombre} className="person-tag">
                                                {person.foto && <img src={person.foto} alt={person.nombre} className="person-avatar" />}
                                                {person.nombre}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            <div className="trip-detail-map" ref={mapRef}></div>
                            <h3 style={{fontSize: '1.5rem', marginBottom: '1.5rem', color: 'var(--secondary)'}}>üó∫Ô∏è Destinos</h3>
                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))', gap: '1.5rem'}}>
                                {trip.destinos.map((destino, index) => (
                                    <div key={index} style={{background: 'var(--light)', borderRadius: '12px', overflow: 'hidden', border: '2px solid var(--border)'}}>
                                        {destino.foto && <img src={destino.foto} alt={destino.lugar} style={{width: '100%', height: '150px', objectFit: 'cover'}} />}
                                        <div style={{padding: '1rem'}}>
                                            <div style={{fontSize: '1.1rem', fontWeight: '700', color: 'var(--secondary)', marginBottom: '0.5rem'}}>{destino.lugar}</div>
                                            {destino.fechaInicio && <div style={{fontSize: '0.85rem', color: '#666'}}>{formatDateRange(destino.fechaInicio, destino.fechaFinal)}</div>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                            {trip.notas && (
                                <div style={{marginTop: '2rem', padding: '1.5rem', background: 'var(--light)', borderRadius: '12px'}}>
                                    <h4 style={{fontSize: '1.1rem', marginBottom: '0.75rem', color: 'var(--secondary)'}}>üìù Notas</h4>
                                    <p style={{color: '#666', lineHeight: '1.6'}}>{trip.notas}</p>
                                </div>
                            )}
                            <div style={{marginTop: '2rem', display: 'flex', gap: '1rem', justifyContent: 'flex-end'}}>
                                {onEdit && <button className="btn-edit" onClick={() => { onClose(); onEdit(trip); }}>‚úèÔ∏è Editar Viaje</button>}
                                {onDelete && <button className="btn-edit" onClick={() => onDelete(trip.id)} style={{color: '#dc3545', borderColor: '#dc3545'}}>üóëÔ∏è Eliminar Viaje</button>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const DestinoCard = ({ destino, index, formData, onSave, onRemove, isGeocoding, setIsGeocoding }) => {
            const [isEditing, setIsEditing] = useState(!!destino._isNew);
            const [local, setLocal] = useState({ ...destino });
            const [localPreview, setLocalPreview] = useState(destino.foto);
            const fileInputId = 'destino-photo-' + index;

            const handleLocalFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const compressed = await compressImage(reader.result, 800, 0.6);
                        setLocal(prev => ({ ...prev, foto: compressed }));
                        setLocalPreview(compressed);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleSave = async () => {
                if (!local.lugar) return;
                setIsGeocoding(true);
                const coordinates = local.coordinates || await geocodePlace(local.lugar);
                const { _isNew, ...rest } = local;
                onSave(index, { ...rest, coordinates });
                setIsEditing(false);
                setIsGeocoding(false);
            };

            const handleCancel = () => {
                if (destino._isNew) { onRemove(index); return; }
                setLocal({ ...destino });
                setLocalPreview(destino.foto);
                setIsEditing(false);
            };

            if (isEditing) {
                return (
                    <div className="destination-item" style={{borderColor: 'var(--primary)'}}>
                        <div className="form-grid">
                            <div className="form-group"><label>Lugar *</label><input type="text" value={local.lugar} onChange={(e) => setLocal({...local, lugar: e.target.value})} placeholder="Par√≠s, Francia" /></div>
                            <div className="form-group"><label>Fecha inicio</label><input type="date" value={local.fechaInicio || ''} onChange={(e) => setLocal({...local, fechaInicio: e.target.value})} min={formData.fechaInicio} max={formData.fechaFinal || undefined} /></div>
                            <div className="form-group"><label>Fecha final</label><input type="date" value={local.fechaFinal || ''} onChange={(e) => setLocal({...local, fechaFinal: e.target.value})} min={local.fechaInicio || formData.fechaInicio} max={formData.fechaFinal || undefined} /></div>
                            <div className="form-group">
                                <label>Foto</label>
                                <div className="file-input-wrapper">
                                    <input type="file" id={fileInputId} accept="image/*" onChange={handleLocalFileChange} />
                                    <label htmlFor={fileInputId} className="file-input-label">üì∏ {local.foto ? 'Cambiar foto' : 'Seleccionar foto'}</label>
                                </div>
                                {localPreview && <img src={localPreview} alt="Preview" className="image-preview" />}
                            </div>
                        </div>
                        <div style={{display: 'flex', gap: '0.5rem', marginTop: '1rem'}}>
                            <button type="button" className="btn-secondary" onClick={handleSave} disabled={!local.lugar || isGeocoding}>
                                {isGeocoding ? <span className="loading"></span> : 'üíæ Guardar'}
                            </button>
                            <button type="button" className="btn-edit" onClick={handleCancel}>Cancelar</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="destination-item">
                    <button type="button" className="btn-remove" onClick={() => onRemove(index)}>√ó</button>
                    <h4>üìç {destino.lugar}</h4>
                    {(destino.fechaInicio || destino.fechaFinal) && <p style={{fontSize: '0.9rem', color: '#666', marginBottom: '0.5rem'}}>{formatDateRange(destino.fechaInicio, destino.fechaFinal)}</p>}
                    {destino.foto && <img src={destino.foto} alt={destino.lugar} className="image-preview" />}
                    <button type="button" className="btn-edit-destino" onClick={() => setIsEditing(true)}>‚úèÔ∏è Editar</button>
                </div>
            );
        };

        const AddTripForm = ({ onAddTrip, allPeople, allDestinations, editingTrip, onCancelEdit, existingTrips, showToast, onImportTrips }) => {
            const [formData, setFormData] = useState(editingTrip || { fechaInicio: '', fechaFinal: '', motivo: 'placer', personas: [], destinos: [], notas: '' });
            const [currentPerson, setCurrentPerson] = useState({ nombre: '', foto: null });
            const [personPreviewUrl, setPersonPreviewUrl] = useState(null);
            const [isGeocoding, setIsGeocoding] = useState(false);

            useEffect(() => { if (editingTrip) setFormData(editingTrip); }, [editingTrip]);

            const handleAddPerson = (personData) => {
                const nombre = typeof personData === 'string' ? personData : personData.nombre;
                const foto = typeof personData === 'string' ? null : personData.foto;
                if (!nombre || formData.personas.some(p => p.nombre === nombre)) return;
                setFormData({ ...formData, personas: [...formData.personas, { nombre, foto }] });
                setCurrentPerson({ nombre: '', foto: null });
                setPersonPreviewUrl(null);
            };

            const handleRemovePerson = (nombre) => setFormData({ ...formData, personas: formData.personas.filter(p => p.nombre !== nombre) });

            const handlePersonPhotoChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const compressed = await compressImage(reader.result, 200, 0.7);
                        setCurrentPerson(prev => ({ ...prev, foto: compressed }));
                        setPersonPreviewUrl(compressed);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleCSVImportComplete = (importedTrips, errors) => {
                onImportTrips(importedTrips);
                const errCount = errors.length;
                const msg = 'Se importaron ' + importedTrips.length + ' viajes' + (errCount > 0 ? ' (' + errCount + ' advertencias)' : '');
                showToast(msg, 'success');
            };


            const handleSubmit = (e) => {
                e.preventDefault();
                if (formData.destinos.length === 0) { showToast('Agrega al menos un destino', 'warning'); return; }
                const trip = editingTrip ? { ...formData } : { ...formData, id: Date.now(), createdAt: new Date().toISOString() };
                onAddTrip(trip);
                if (!editingTrip) setFormData({ fechaInicio: '', fechaFinal: '', motivo: 'placer', personas: [], destinos: [], notas: '' });
            };

            const suggestedPeople = allPeople.filter(p => !formData.personas.some(fp => fp.nombre === p.nombre));
            const savedDestinations = allDestinations.filter(d => !formData.destinos.some(fd => fd.lugar === d.lugar));

            return (
                <div className="add-trip-section">
                    <h2 className="form-title">
                        <span>{editingTrip ? '‚úèÔ∏è Editar Viaje' : '‚úàÔ∏è Agregar Nuevo Viaje'}</span>
                        {editingTrip && <button className="btn-edit" onClick={onCancelEdit}>Cancelar</button>}
                    </h2>
                    
                    {!editingTrip && (
                        <CSVImportPanel onImportComplete={handleCSVImportComplete} existingTrips={existingTrips || []} showToast={showToast} />
                    )}
                    
                    <form onSubmit={handleSubmit}>
                        <div className="form-section">
                            <h3 className="form-section-title">Informaci√≥n General</h3>
                            <div className="form-grid">
                                <div className="form-group"><label>Fecha Inicio *</label><input type="date" value={formData.fechaInicio} onChange={(e) => setFormData({ ...formData, fechaInicio: e.target.value })} required /></div>
                                <div className="form-group"><label>Fecha Final</label><input type="date" value={formData.fechaFinal} onChange={(e) => setFormData({ ...formData, fechaFinal: e.target.value })} min={formData.fechaInicio} /></div>
                                <div className="form-group">
                                    <label>Motivo del viaje</label>
                                    <select value={formData.motivo} onChange={(e) => setFormData({ ...formData, motivo: e.target.value })}>
                                        <option value="placer">üèñÔ∏è Placer</option>
                                        <option value="negocios">üíº Negocios</option>
                                        <option value="evento">üéâ Evento</option>
                                        <option value="familia">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia</option>
                                        <option value="estudio">üìö Estudio</option>
                                        <option value="otro">üåü Otro</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div className="form-section">
                            <h3 className="form-section-title">Destinos</h3>

                            {savedDestinations.length > 0 && (
                                <div style={{marginBottom: '1rem'}}>
                                    <label>Seleccionar destino guardado:</label>
                                    <div className="suggested-people">
                                        {savedDestinations.slice(0, 10).map(dest => (
                                            <div key={dest.lugar} className="suggested-person" onClick={() => {
                                                const newDest = { lugar: dest.lugar, fechaInicio: '', fechaFinal: '', foto: null, coordinates: dest.coordinates };
                                                setFormData(prev => ({ ...prev, destinos: [...prev.destinos, newDest] }));
                                            }}>üìç {dest.lugar}</div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <div className="destinations-list">
                                {formData.destinos.map((destino, index) => (
                                    <DestinoCard key={index} destino={destino} index={index} formData={formData}
                                        onSave={(idx, updated) => { const nd = [...formData.destinos]; nd[idx] = updated; setFormData({...formData, destinos: nd}); }}
                                        onRemove={(idx) => setFormData({...formData, destinos: formData.destinos.filter((_, i) => i !== idx)})}
                                        isGeocoding={isGeocoding} setIsGeocoding={setIsGeocoding}
                                    />
                                ))}
                            </div>

                            <div className="destination-item" style={{border: '2px dashed var(--border)', cursor: 'pointer', textAlign: 'center', padding: '1.5rem'}}
                                onClick={() => {
                                    setFormData(prev => ({...prev, destinos: [...prev.destinos, { lugar: '', fechaInicio: '', fechaFinal: '', foto: null, coordinates: null, _isNew: true }]}));
                                }}>
                                <span style={{fontSize: '1.1rem', color: 'var(--secondary)', fontWeight: '600'}}>‚ûï Agregar Destino</span>
                            </div>
                        </div>

                        <div className="form-section">
                            <h3 className="form-section-title">Acompa√±antes</h3>
                            <div className="form-grid">
                                <div className="form-group"><label>Nombre</label><input type="text" value={currentPerson.nombre} onChange={(e) => setCurrentPerson({...currentPerson, nombre: e.target.value})} placeholder="Nombre de la persona" onKeyPress={(e) => { if (e.key === 'Enter') { e.preventDefault(); handleAddPerson(currentPerson); } }} /></div>
                                <div className="form-group">
                                    <label>Foto (opcional)</label>
                                    <div className="file-input-wrapper">
                                        <input type="file" id="person-photo" accept="image/*" onChange={handlePersonPhotoChange} />
                                        <label htmlFor="person-photo" className="file-input-label">üì∏ {currentPerson.foto ? 'Cambiar foto' : 'Seleccionar foto'}</label>
                                    </div>
                                    {personPreviewUrl && <img src={personPreviewUrl} alt="Preview" className="image-preview" style={{height: '100px'}} />}
                                </div>
                            </div>
                            <button type="button" className="btn-secondary" onClick={() => handleAddPerson(currentPerson)} style={{marginTop: '1rem'}}>+ Agregar Persona</button>

                            {suggestedPeople.length > 0 && (
                                <div>
                                    <label style={{marginTop: '1rem', display: 'block'}}>Personas frecuentes:</label>
                                    <div className="suggested-people">
                                        {suggestedPeople.map(person => (
                                            <div key={person.nombre} className="suggested-person" onClick={() => handleAddPerson(person)}>
                                                {person.foto && <img src={person.foto} alt={person.nombre} className="person-avatar" />}
                                                {person.nombre}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {formData.personas.length > 0 && (
                                <div className="people-container">
                                    {formData.personas.map(person => (
                                        <div key={person.nombre} className="person-tag">
                                            {person.foto && <img src={person.foto} alt={person.nombre} className="person-avatar" />}
                                            {person.nombre}
                                            <button type="button" onClick={() => handleRemovePerson(person.nombre)}>√ó</button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        <div className="form-section">
                            <h3 className="form-section-title">Notas adicionales</h3>
                            <textarea value={formData.notas} onChange={(e) => setFormData({ ...formData, notas: e.target.value })} placeholder="Actividades, recomendaciones, presupuesto..." />
                        </div>

                        <button type="submit" className="btn-primary" style={{marginTop: '1rem'}}>
                            {editingTrip ? 'üíæ Guardar Cambios' : '‚úàÔ∏è Guardar Viaje'}
                        </button>
                    </form>
                </div>
            );
        };

        const CSVImportPanel = ({ onImportComplete, existingTrips, showToast }) => {
            const [stage, setStage] = useState('idle');
            const [parsedData, setParsedData] = useState({ trips: [], errors: [] });
            const [geocodeProgress, setGeocodeProgress] = useState({ done: 0, total: 0 });
            const [selectedTrips, setSelectedTrips] = useState(new Set());

            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const result = parseCSVRows(event.target.result);
                    if (result.trips.length === 0) {
                        showToast('No se encontraron viajes en el CSV. Verifica el formato.', 'error');
                        return;
                    }
                    const withDuplicates = detectDuplicates(result.trips, existingTrips);
                    setParsedData({ trips: withDuplicates, errors: result.errors });
                    const nonDupIndices = new Set();
                    withDuplicates.forEach((t, i) => { if (!t._isDuplicate) nonDupIndices.add(i); });
                    setSelectedTrips(nonDupIndices);
                    setStage('preview');
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const handleImport = async () => {
                const tripsToImport = parsedData.trips.filter((_, i) => selectedTrips.has(i));
                if (tripsToImport.length === 0) { showToast('Selecciona al menos un viaje para importar', 'warning'); return; }
                setStage('importing');
                const totalDest = tripsToImport.reduce((sum, t) => sum + t.destinos.length, 0);
                setGeocodeProgress({ done: 0, total: totalDest });
                const { trips: geocodedTrips, errors: geoErrors } = await geocodeTrips(
                    tripsToImport,
                    (done, total) => setGeocodeProgress({ done, total })
                );
                const cleanTrips = geocodedTrips.map(t => { const { _isDuplicate, ...rest } = t; return rest; });
                const allErrors = [...parsedData.errors, ...geoErrors.map(e => ({ row: '-', message: e.lugar + ': ' + e.message }))];
                onImportComplete(cleanTrips, allErrors);
                setStage('idle');
                setParsedData({ trips: [], errors: [] });
            };

            const toggleTrip = (index) => {
                const next = new Set(selectedTrips);
                if (next.has(index)) next.delete(index); else next.add(index);
                setSelectedTrips(next);
            };

            const toggleAll = () => {
                if (selectedTrips.size === parsedData.trips.length) setSelectedTrips(new Set());
                else setSelectedTrips(new Set(parsedData.trips.map((_, i) => i)));
            };

            if (stage === 'importing') {
                const pct = geocodeProgress.total > 0 ? Math.round((geocodeProgress.done / geocodeProgress.total) * 100) : 0;
                return (
                    <div className="csv-import">
                        <h4>Importando viajes...</h4>
                        <p style={{color: '#666', marginBottom: '0.5rem'}}>Geocodificando destinos: {geocodeProgress.done}/{geocodeProgress.total}</p>
                        <div className="csv-progress-bar"><div className="csv-progress-fill" style={{width: pct + '%'}}></div></div>
                        <p style={{fontSize: '0.85rem', color: '#888'}}>Esto puede tardar unos segundos debido al limite de velocidad del servicio de geolocalizacion.</p>
                    </div>
                );
            }

            if (stage === 'preview') {
                const selectedCount = selectedTrips.size;
                return (
                    <div className="csv-import" style={{borderColor: 'var(--secondary)'}}>
                        <h4>Vista previa de importacion</h4>
                        <p style={{color: '#666', marginBottom: '1rem'}}>Se encontraron <strong>{parsedData.trips.length}</strong> viajes con <strong>{parsedData.trips.reduce((s, t) => s + t.destinos.length, 0)}</strong> destinos</p>

                        {parsedData.errors.length > 0 && (
                            <div style={{background: '#fff3cd', padding: '0.75rem 1rem', borderRadius: '8px', marginBottom: '1rem', fontSize: '0.85rem'}}>
                                <strong>Advertencias ({parsedData.errors.length}):</strong>
                                {parsedData.errors.slice(0, 5).map((err, i) => (
                                    <div key={i} style={{marginTop: '0.25rem'}}>Fila {err.row}: {err.message}</div>
                                ))}
                                {parsedData.errors.length > 5 && <div style={{marginTop: '0.25rem'}}>...y {parsedData.errors.length - 5} mas</div>}
                            </div>
                        )}

                        <div style={{marginBottom: '0.75rem'}}>
                            <label style={{cursor: 'pointer', fontSize: '0.9rem'}}>
                                <input type="checkbox" checked={selectedTrips.size === parsedData.trips.length} onChange={toggleAll} style={{marginRight: '0.5rem'}} />
                                Seleccionar todos
                            </label>
                        </div>

                        <table className="csv-preview-table">
                            <thead>
                                <tr><th></th><th>Fecha</th><th>Destinos</th><th>Motivo</th><th>Personas</th><th>Estado</th></tr>
                            </thead>
                            <tbody>
                                {parsedData.trips.map((trip, i) => (
                                    <tr key={i} className={trip._isDuplicate ? 'duplicate' : ''}>
                                        <td><input type="checkbox" checked={selectedTrips.has(i)} onChange={() => toggleTrip(i)} /></td>
                                        <td>{trip.fechaInicio}{trip.fechaFinal && trip.fechaFinal !== trip.fechaInicio ? ' - ' + trip.fechaFinal : ''}</td>
                                        <td>{trip.destinos.map(d => d.lugar).join(', ')}</td>
                                        <td>{getMotivoEmoji(trip.motivo)} {trip.motivo}</td>
                                        <td>{trip.personas.map(p => p.nombre).join(', ') || '-'}</td>
                                        <td>{trip._isDuplicate ? '‚ö†Ô∏è Duplicado' : '‚úÖ Nuevo'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>

                        <div style={{display: 'flex', gap: '1rem', marginTop: '1rem'}}>
                            <button className="btn-primary" onClick={handleImport} disabled={selectedCount === 0}>
                                Importar seleccionados ({selectedCount})
                            </button>
                            <button className="btn-edit" onClick={() => { setStage('idle'); setParsedData({ trips: [], errors: [] }); }}>Cancelar</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="csv-import">
                    <h4>üì§ Importar viajes desde CSV</h4>
                    <div className="csv-help">Sube un archivo CSV con tus viajes. El encabezado debe incluir columnas como: tripId, tripFechaInicio, tripFechaFinal, motivo, personas, notas, lugar, destFechaInicio, destFechaFinal</div>
                    <div className="csv-example">tripId,tripFechaInicio,tripFechaFinal,motivo,personas,notas,lugar,destFechaInicio,destFechaFinal</div>
                    <input type="file" accept=".csv" onChange={handleFileSelect} />
                </div>
            );
        };

        const DataManagementPanel = ({ trips, lastImportDate, onExportJSON, onExportCSV, onImportJSON, onClearAll }) => {
            const jsonInputRef = useRef(null);
            return (
                <div className="add-trip-section" style={{marginTop: '2rem'}}>
                    <h2 className="form-title">Gestion de Datos</h2>
                    <div style={{display: 'flex', gap: '2rem', flexWrap: 'wrap', marginBottom: '1.5rem', padding: '1rem', background: 'var(--light)', borderRadius: '12px'}}>
                        <div><strong>{trips.length}</strong> viajes guardados</div>
                        <div><strong>{trips.reduce((sum, t) => sum + t.destinos.length, 0)}</strong> destinos totales</div>
                        {lastImportDate && <div>Ultima importacion: {new Date(lastImportDate).toLocaleDateString('es-ES')}</div>}
                    </div>
                    <div className="form-section">
                        <h3 className="form-section-title">Exportar</h3>
                        <div style={{display: 'flex', gap: '1rem', flexWrap: 'wrap'}}>
                            <button className="btn-secondary" onClick={onExportJSON}>Descargar Backup (JSON)</button>
                            <button className="btn-secondary" onClick={onExportCSV}>Descargar CSV</button>
                        </div>
                    </div>
                    <div className="form-section">
                        <h3 className="form-section-title">Restaurar Backup</h3>
                        <p style={{fontSize: '0.9rem', color: '#666', marginBottom: '1rem'}}>Sube un archivo JSON de backup previamente exportado. Esto reemplazara todos los datos actuales.</p>
                        <input type="file" accept=".json" onChange={onImportJSON} ref={jsonInputRef} />
                    </div>
                    <div className="form-section">
                        <h3 className="form-section-title">Zona de Peligro</h3>
                        <button className="btn-edit" onClick={onClearAll} style={{color: '#dc3545', borderColor: '#dc3545'}}>Borrar Todos los Datos</button>
                    </div>
                </div>
            );
        };

        const TimelineView = ({ trips, onTripClick }) => {
            if (trips.length === 0) return <div className="empty-state"><div className="empty-state-icon">üìÖ</div><div className="empty-state-text">No hay viajes registrados a√∫n</div></div>;
            const tripsByYear = {};
            trips.forEach(trip => {
                const year = new Date(trip.fechaInicio).getFullYear();
                if (!tripsByYear[year]) tripsByYear[year] = {};
                const month = new Date(trip.fechaInicio).getMonth();
                if (!tripsByYear[year][month]) tripsByYear[year][month] = [];
                tripsByYear[year][month].push(trip);
            });
            const years = Object.keys(tripsByYear).sort((a, b) => b - a);

            return (
                <div>
                    {years.map(year => {
                        const months = Array.from({ length: 12 }, (_, i) => ({
                            index: i,
                            name: new Date(year, i).toLocaleDateString('es-ES', { month: 'short' }),
                            trips: tripsByYear[year][i] || []
                        }));

                        return (
                            <div key={year} className="timeline-year-container">
                                <h2 className="timeline-year-header">{year}</h2>
                                <div className="timeline-horizontal">
                                    <div className="timeline-line"></div>
                                    <div className="timeline-months">
                                        {months.map(month => (
                                            <div key={month.index} className="timeline-month">
                                                <div className="timeline-month-dot"></div>
                                                <div className="timeline-month-label">{month.name}</div>
                                                <div className="timeline-month-trips">
                                                    {month.trips.map(trip => {
                                                        const firstDestino = trip.destinos[0];
                                                        const duracion = trip.fechaFinal ? Math.ceil((new Date(trip.fechaFinal) - new Date(trip.fechaInicio)) / (1000 * 60 * 60 * 24)) : 1;
                                                        return (
                                                            <div key={trip.id} className="timeline-trip-mini" onClick={() => onTripClick(trip)}>
                                                                {firstDestino?.foto && <img src={firstDestino.foto} alt={firstDestino.lugar} className="timeline-trip-mini-image" />}
                                                                <div className="timeline-trip-mini-title">{trip.destinos.map(d => d.lugar).join(', ')}</div>
                                                                <div className="timeline-trip-mini-meta">
                                                                    <span>{getMotivoEmoji(trip.motivo)}</span>
                                                                    <span>{duracion}d</span>
                                                                    <span>üìç{trip.destinos.length}</span>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const DashboardView = ({ trips, homeCoords }) => {
            if (trips.length === 0) return <div className="empty-state"><div className="empty-state-icon">üìä</div><div className="empty-state-text">Agrega viajes para ver tus m√©tricas</div></div>;

            // --- Section 1: Overview ---
            const totalTrips = trips.length;
            const allDest = trips.flatMap(t => t.destinos);
            const uniquePlaces = new Set(allDest.map(d => d.lugar)).size;
            const totalDays = trips.reduce((sum, t) => sum + Math.max(1, t.fechaFinal ? Math.ceil((new Date(t.fechaFinal) - new Date(t.fechaInicio)) / 86400000) : 1), 0);
            const avgTripLength = Math.round(totalDays / totalTrips);
            const longestTrip = trips.reduce((best, t) => { const d = Math.max(1, t.fechaFinal ? Math.ceil((new Date(t.fechaFinal) - new Date(t.fechaInicio)) / 86400000) : 1); return d > best.days ? { name: t.destinos.map(dd => dd.lugar).join(', '), days: d } : best; }, { name: '', days: 0 });
            let totalKm = 0;
            if (homeCoords) {
                trips.forEach(trip => {
                    let last = homeCoords;
                    trip.destinos.forEach(d => { if (d.coordinates) { totalKm += calculateDistance(last.lat, last.lng, d.coordinates.lat, d.coordinates.lng); last = d.coordinates; } });
                    totalKm += calculateDistance(last.lat, last.lng, homeCoords.lat, homeCoords.lng);
                });
            }

            // --- Section 2: Travel Patterns ---
            const monthCounts = Array(12).fill(0);
            const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            trips.forEach(t => { monthCounts[new Date(t.fechaInicio).getMonth()]++; });
            const maxMonth = Math.max(...monthCounts);
            const busiestMonthIdx = monthCounts.indexOf(maxMonth);

            // Southern hemisphere seasons (Argentina)
            const seasonMap = [0,0,1,1,1,2,2,2,3,3,3,0]; // Dec-Feb=Verano(0), Mar-May=Oto√±o(1), Jun-Aug=Invierno(2), Sep-Nov=Primavera(3)
            const seasonNames = ['‚òÄÔ∏è Verano', 'üçÇ Oto√±o', '‚ùÑÔ∏è Invierno', 'üå∏ Primavera'];
            const seasonCounts = [0, 0, 0, 0];
            trips.forEach(t => { seasonCounts[seasonMap[new Date(t.fechaInicio).getMonth()]]++; });

            // Travel streaks (consecutive months with trips)
            const monthsWithTrips = new Set();
            trips.forEach(t => { const d = new Date(t.fechaInicio); monthsWithTrips.add(d.getFullYear() * 12 + d.getMonth()); });
            const sortedMonths = [...monthsWithTrips].sort((a, b) => a - b);
            let maxStreak = 0, streak = 1;
            for (let i = 1; i < sortedMonths.length; i++) {
                if (sortedMonths[i] === sortedMonths[i - 1] + 1) { streak++; maxStreak = Math.max(maxStreak, streak); }
                else { streak = 1; }
            }
            maxStreak = Math.max(maxStreak, streak);
            if (sortedMonths.length === 0) maxStreak = 0;

            // --- Section 3: Geography ---
            const placeCount = {};
            allDest.forEach(d => { placeCount[d.lugar] = (placeCount[d.lugar] || 0) + 1; });
            const placeEntries = Object.entries(placeCount).sort((a, b) => b[1] - a[1]);
            const mostVisited = placeEntries[0];
            const newPlaces = placeEntries.filter(([_, c]) => c === 1).length;
            const revisitedPlaces = placeEntries.filter(([_, c]) => c > 1).length;
            const avgDestsPerTrip = (allDest.length / totalTrips).toFixed(1);

            let furthest = { name: '-', km: 0 };
            if (homeCoords) {
                allDest.forEach(d => {
                    if (d.coordinates) {
                        const km = calculateDistance(homeCoords.lat, homeCoords.lng, d.coordinates.lat, d.coordinates.lng);
                        if (km > furthest.km) furthest = { name: d.lugar, km };
                    }
                });
            }

            // --- Section 4: Social ---
            const soloTrips = trips.filter(t => !t.personas || t.personas.length === 0).length;
            const groupTrips = totalTrips - soloTrips;
            const motivoCount = {};
            trips.forEach(t => { motivoCount[t.motivo] = (motivoCount[t.motivo] || 0) + 1; });
            const motivoEntries = Object.entries(motivoCount).sort((a, b) => b[1] - a[1]);
            const maxMotivo = motivoEntries.length > 0 ? motivoEntries[0][1] : 1;

            const peopleStats = {};
            trips.forEach(trip => {
                trip.personas.forEach(p => {
                    if (!peopleStats[p.nombre]) peopleStats[p.nombre] = { count: 0, foto: p.foto };
                    peopleStats[p.nombre].count++;
                    if (p.foto && !peopleStats[p.nombre].foto) peopleStats[p.nombre].foto = p.foto;
                });
            });
            const topCompanion = Object.entries(peopleStats).sort((a, b) => b[1].count - a[1].count)[0];
            const groupSizes = trips.filter(t => t.personas.length > 0).map(t => t.personas.length + 1);
            const avgGroupSize = groupSizes.length > 0 ? (groupSizes.reduce((a, b) => a + b, 0) / groupSizes.length).toFixed(1) : '-';

            return (
                <div>
                    {/* Section 1: Overview Cards */}
                    <div className="dashboard-section">
                        <h2 className="dashboard-section-title">üìä Resumen General</h2>
                        <div className="dashboard-grid">
                            <div className="metric-card"><div className="metric-icon">‚úàÔ∏è</div><div className="metric-value">{totalTrips}</div><div className="metric-label">Viajes</div></div>
                            <div className="metric-card"><div className="metric-icon">üìÖ</div><div className="metric-value">{totalDays}</div><div className="metric-label">D√≠as viajando</div></div>
                            <div className="metric-card"><div className="metric-icon">üó∫Ô∏è</div><div className="metric-value">{uniquePlaces}</div><div className="metric-label">Lugares √∫nicos</div></div>
                            <div className="metric-card"><div className="metric-icon">üåç</div><div className="metric-value">{Math.round(totalKm).toLocaleString()}</div><div className="metric-label">Kil√≥metros</div><div className="metric-detail">{(totalKm / 40075).toFixed(2)}x la vuelta al mundo</div></div>
                            <div className="metric-card"><div className="metric-icon">‚è±Ô∏è</div><div className="metric-value">{avgTripLength}</div><div className="metric-label">Promedio d√≠as/viaje</div></div>
                            <div className="metric-card"><div className="metric-icon">üèÜ</div><div className="metric-value">{longestTrip.days}d</div><div className="metric-label">Viaje m√°s largo</div><div className="metric-detail">{longestTrip.name}</div></div>
                        </div>
                    </div>

                    {/* Section 2: Travel Patterns */}
                    <div className="dashboard-section">
                        <h2 className="dashboard-section-title">üìà Patrones de Viaje</h2>
                        <div style={{background: 'white', padding: '2rem', borderRadius: '16px', boxShadow: '0 4px 20px rgba(0,0,0,0.08)', border: '2px solid var(--border)', marginBottom: '1.5rem'}}>
                            <h3 style={{fontSize: '1.1rem', color: 'var(--secondary)', marginBottom: '1.25rem'}}>Frecuencia Mensual</h3>
                            {monthNames.map((m, i) => (
                                <div key={i} className="dashboard-bar-row">
                                    <div className="dashboard-bar-label" style={{fontWeight: i === busiestMonthIdx ? '800' : '600', color: i === busiestMonthIdx ? 'var(--primary)' : 'var(--secondary)'}}>{m}</div>
                                    <div className="dashboard-bar-track">
                                        <div className="dashboard-bar-fill" style={{width: maxMonth > 0 ? Math.max(monthCounts[i] > 0 ? 8 : 0, (monthCounts[i] / maxMonth) * 100) + '%' : '0%', background: i === busiestMonthIdx ? 'linear-gradient(135deg, var(--accent) 0%, #d14060 100%)' : undefined}}>
                                            {monthCounts[i] > 0 && <span className="dashboard-bar-value">{monthCounts[i]}</span>}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="dashboard-mini-grid">
                            {seasonNames.map((s, i) => (
                                <div key={i} className="dashboard-mini-card">
                                    <div style={{fontSize: '1.5rem', marginBottom: '0.25rem'}}>{s}</div>
                                    <div className="dashboard-mini-value">{seasonCounts[i]}</div>
                                    <div className="dashboard-mini-label">viajes</div>
                                </div>
                            ))}
                            <div className="dashboard-mini-card">
                                <div style={{fontSize: '1.5rem', marginBottom: '0.25rem'}}>üî•</div>
                                <div className="dashboard-mini-value">{maxStreak}</div>
                                <div className="dashboard-mini-label">Racha (meses consecutivos)</div>
                            </div>
                        </div>
                    </div>

                    {/* Section 3: Geography */}
                    <div className="dashboard-section">
                        <h2 className="dashboard-section-title">üåé Geograf√≠a</h2>
                        <div className="dashboard-grid">
                            <div className="metric-card"><div className="metric-icon">üÜï</div><div className="metric-value">{newPlaces}</div><div className="metric-label">Lugares nuevos</div></div>
                            <div className="metric-card"><div className="metric-icon">üîÑ</div><div className="metric-value">{revisitedPlaces}</div><div className="metric-label">Lugares revisitados</div></div>
                            {furthest.km > 0 && <div className="metric-card"><div className="metric-icon">üìè</div><div className="metric-value">{Math.round(furthest.km).toLocaleString()} km</div><div className="metric-label">Destino m√°s lejano</div><div className="metric-detail">{furthest.name}</div></div>}
                            {mostVisited && <div className="metric-card"><div className="metric-icon">‚ù§Ô∏è</div><div className="metric-value">{mostVisited[1]}</div><div className="metric-label">Lugar m√°s visitado</div><div className="metric-detail">{mostVisited[0]}</div></div>}
                            <div className="metric-card"><div className="metric-icon">üìç</div><div className="metric-value">{avgDestsPerTrip}</div><div className="metric-label">Destinos por viaje (prom.)</div></div>
                        </div>
                    </div>

                    {/* Section 4: Social */}
                    <div className="dashboard-section">
                        <h2 className="dashboard-section-title">üë• Social</h2>
                        <div className="dashboard-grid">
                            <div className="metric-card"><div className="metric-icon">üßç</div><div className="metric-value">{soloTrips}</div><div className="metric-label">Viajes solo/a</div></div>
                            <div className="metric-card"><div className="metric-icon">üë´</div><div className="metric-value">{groupTrips}</div><div className="metric-label">Viajes en grupo</div></div>
                            {topCompanion && <div className="metric-card"><div className="metric-icon">ü•á</div><div className="metric-value">{topCompanion[1].count}</div><div className="metric-label">Compa√±ero/a top</div><div className="metric-detail">{topCompanion[0]}</div></div>}
                            <div className="metric-card"><div className="metric-icon">üë•</div><div className="metric-value">{avgGroupSize}</div><div className="metric-label">Tama√±o grupo (prom.)</div></div>
                        </div>

                        {motivoEntries.length > 0 && (
                            <div style={{background: 'white', padding: '2rem', borderRadius: '16px', boxShadow: '0 4px 20px rgba(0,0,0,0.08)', border: '2px solid var(--border)', marginTop: '1.5rem'}}>
                                <h3 style={{fontSize: '1.1rem', color: 'var(--secondary)', marginBottom: '1.25rem'}}>Viajes por Motivo</h3>
                                {motivoEntries.map(([motivo, count]) => (
                                    <div key={motivo} className="dashboard-bar-row">
                                        <div className="dashboard-bar-label">{getMotivoEmoji(motivo)} {motivo}</div>
                                        <div className="dashboard-bar-track">
                                            <div className="dashboard-bar-fill" style={{width: Math.max(8, (count / maxMotivo) * 100) + '%'}}>
                                                <span className="dashboard-bar-value">{count}</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const WrappedView = ({ trips, selectedYear }) => {
            const yearTrips = trips;
            const label = selectedYear === 'all' ? 'todos los a√±os' : selectedYear;
            if (yearTrips.length === 0) return <div className="empty-state"><div className="empty-state-icon">üéÅ</div><div className="empty-state-text">No hay viajes en {label}</div></div>;

            const allDestinations = yearTrips.flatMap(t => t.destinos);
            const uniquePlaces = [...new Set(allDestinations.map(d => d.lugar))];
            const totalDays = yearTrips.reduce((sum, t) => sum + (t.fechaFinal ? Math.ceil((new Date(t.fechaFinal) - new Date(t.fechaInicio)) / (1000 * 60 * 60 * 24)) : 1), 0);
            let totalKm = 0;
            const destinationsWithCoords = allDestinations.filter(d => d.coordinates);
            for (let i = 0; i < destinationsWithCoords.length - 1; i++) {
                const d1 = destinationsWithCoords[i].coordinates;
                const d2 = destinationsWithCoords[i + 1].coordinates;
                totalKm += calculateDistance(d1.lat, d1.lng, d2.lat, d2.lng);
            }
            const allPeople = [...new Set(yearTrips.flatMap(t => t.personas.map(p => p.nombre)))];
            const avgDaysPerTrip = Math.round(totalDays / yearTrips.length);

            return (
                <div className="wrapped-container">
                    <div className="wrapped-gallery">
                        <div className="wrapped-card">
                            <div className="wrapped-card-icon">‚úàÔ∏è</div>
                            <div className="wrapped-card-value">{yearTrips.length}</div>
                            <div className="wrapped-card-label">Viajes</div>
                            <div className="wrapped-card-detail">Un a√±o lleno de aventuras</div>
                        </div>
                        <div className="wrapped-card">
                            <div className="wrapped-card-icon">üó∫Ô∏è</div>
                            <div className="wrapped-card-value">{uniquePlaces.length}</div>
                            <div className="wrapped-card-label">Lugares</div>
                            <div className="wrapped-card-detail">Cada uno √∫nico</div>
                        </div>
                        <div className="wrapped-card">
                            <div className="wrapped-card-icon">üìÖ</div>
                            <div className="wrapped-card-value">{totalDays}</div>
                            <div className="wrapped-card-label">D√≠as viajando</div>
                            <div className="wrapped-card-detail">~{avgDaysPerTrip} d√≠as/viaje</div>
                        </div>
                        <div className="wrapped-card">
                            <div className="wrapped-card-icon">üåç</div>
                            <div className="wrapped-card-value">{Math.round(totalKm / 1000)}K</div>
                            <div className="wrapped-card-label">Kil√≥metros</div>
                            <div className="wrapped-card-detail">{(totalKm / 40075).toFixed(2)}x la vuelta al mundo</div>
                        </div>
                        {allPeople.length > 0 && (
                            <div className="wrapped-card">
                                <div className="wrapped-card-icon">üë•</div>
                                <div className="wrapped-card-value">{allPeople.length}</div>
                                <div className="wrapped-card-label">Compa√±eros</div>
                                <div className="wrapped-card-detail">Momentos compartidos</div>
                            </div>
                        )}
                        <div className="wrapped-card wrapped-places-card">
                            <div className="wrapped-card-icon">üèÜ</div>
                            <h3 style={{fontSize: '1.4rem', marginBottom: '0.75rem'}}>Destinos {label}</h3>
                            <div className="wrapped-places-grid">
                                {uniquePlaces.map((place, i) => <div key={i} className="wrapped-place-tag">{place}</div>)}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TripsListView = ({ trips, onTripClick, onEditTrip, onDeleteTrip }) => {
            if (trips.length === 0) return <div className="empty-state"><div className="empty-state-icon">‚úàÔ∏è</div><div className="empty-state-text">No hay viajes registrados a√∫n</div></div>;
            const sortedTrips = [...trips].sort((a, b) => new Date(b.fechaInicio) - new Date(a.fechaInicio));

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                        <h2 style={{fontSize: '2rem', color: 'var(--secondary)'}}>Todos los Viajes</h2>
                    </div>
                    <div className="trips-list">
                        {sortedTrips.map(trip => (
                            <TripCard key={trip.id} trip={trip} onClick={() => onTripClick(trip)} showEditButton={true} onEdit={onEditTrip} onDelete={onDeleteTrip} />
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('settings');
            const [trips, setTrips] = useState([]);
            const [profile, setProfile] = useState(null);
            const [homeCoords, setHomeCoords] = useState(null);
            const [selectedYear, setSelectedYear] = useState('all');
            const [showAddForm, setShowAddForm] = useState(false);
            const [selectedTrip, setSelectedTrip] = useState(null);
            const [editingTrip, setEditingTrip] = useState(null);
            const [toasts, setToasts] = useState([]);
            const [confirmDialog, setConfirmDialog] = useState({ isOpen: false, title: '', message: '', onConfirm: null, danger: false });
            const [lastImportDate, setLastImportDate] = useState(localStorage.getItem('nomadAtlasLastImport'));

            const showToast = (message, type) => {
                type = type || 'success';
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 4000);
            };

            const showConfirm = (title, message, onConfirm, danger) => {
                setConfirmDialog({ isOpen: true, title, message, onConfirm: () => { onConfirm(); setConfirmDialog(d => ({...d, isOpen: false})); }, danger: !!danger });
            };

            useEffect(() => {
                const savedTrips = localStorage.getItem('nomadAtlasTrips');
                const savedProfile = localStorage.getItem('nomadAtlasProfile');
                if (savedTrips) {
                    try { setTrips(JSON.parse(savedTrips)); }
                    catch (e) { console.error('Error loading trips:', e); }
                }
                if (savedProfile) {
                    try {
                        const prof = JSON.parse(savedProfile);
                        setProfile(prof);
                        if (prof.ubicacion) {
                            geocodePlace(prof.ubicacion).then(coords => {
                                if (coords) setHomeCoords(coords);
                            });
                        }
                        setActiveTab('map');
                    }
                    catch (e) { console.error('Error loading profile:', e); }
                }
            }, []);

            useEffect(() => { safeSetItem('nomadAtlasTrips', JSON.stringify(trips), showToast); }, [trips]);
            useEffect(() => {
                if (profile) {
                    safeSetItem('nomadAtlasProfile', JSON.stringify(profile), showToast);
                    if (profile.ubicacion && !homeCoords) {
                        geocodePlace(profile.ubicacion).then(coords => {
                            if (coords) setHomeCoords(coords);
                        });
                    }
                }
            }, [profile]);

            const handleAddTrip = (trip) => {
                if (editingTrip) {
                    setTrips(trips.map(t => t.id === trip.id ? trip : t));
                    setEditingTrip(null);
                } else {
                    setTrips([trip, ...trips]);
                }
                setShowAddForm(false);
            };

            const handleImportTrips = (newTrips) => {
                setTrips(prev => [...newTrips, ...prev]);
                safeSetItem('nomadAtlasLastImport', new Date().toISOString());
                setLastImportDate(new Date().toISOString());
                setActiveTab('trips');
            };

            const handleUpdateProfile = (newProfile) => {
                setProfile(newProfile);
                if (newProfile.ubicacion) {
                    geocodePlace(newProfile.ubicacion).then(coords => {
                        if (coords) setHomeCoords(coords);
                    });
                }
                setActiveTab('map');
            };

            const handleEditTrip = (trip) => { setEditingTrip(trip); setShowAddForm(true); setActiveTab('trips'); };

            const handleDeleteTrip = (tripId) => {
                showConfirm(
                    'Eliminar Viaje',
                    'Este viaje se eliminara permanentemente. Esta accion no se puede deshacer.',
                    () => {
                        setTrips(prev => prev.filter(t => t.id !== tripId));
                        setSelectedTrip(null);
                        showToast('Viaje eliminado', 'success');
                    },
                    true
                );
            };

            const handleExportJSON = () => {
                const data = { trips, profile, exportedAt: new Date().toISOString(), version: 1 };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'nomad-atlas-backup-' + new Date().toISOString().slice(0, 10) + '.json';
                a.click();
                URL.revokeObjectURL(url);
                showToast('Backup JSON descargado', 'success');
            };

            const handleExportCSV = () => {
                const header = 'tripId,tripFechaInicio,tripFechaFinal,motivo,personas,notas,lugar,destFechaInicio,destFechaFinal';
                const rows = [];
                trips.forEach((trip, tripIndex) => {
                    trip.destinos.forEach(dest => {
                        const escapeCsv = (val) => { const str = String(val || ''); return str.includes(',') || str.includes('"') || str.includes('\n') ? '"' + str.replace(/"/g, '""') + '"' : str; };
                        rows.push([tripIndex + 1, trip.fechaInicio, trip.fechaFinal || '', trip.motivo, trip.personas.map(p => p.nombre).join('; '), escapeCsv(trip.notas), escapeCsv(dest.lugar), dest.fechaInicio || '', dest.fechaFinal || ''].join(','));
                    });
                });
                const csv = header + '\n' + rows.join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'nomad-atlas-viajes-' + new Date().toISOString().slice(0, 10) + '.csv';
                a.click();
                URL.revokeObjectURL(url);
                showToast('CSV descargado', 'success');
            };

            const handleImportJSON = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (!data.trips || !Array.isArray(data.trips)) {
                            showToast('Archivo JSON invalido: no contiene viajes', 'error');
                            return;
                        }
                        showConfirm(
                            'Restaurar Backup',
                            'Este backup contiene ' + data.trips.length + ' viajes' + (data.profile ? ' y un perfil' : '') + '. Los datos actuales seran reemplazados. Continuar?',
                            () => {
                                setTrips(data.trips);
                                if (data.profile) setProfile(data.profile);
                                safeSetItem('nomadAtlasLastImport', new Date().toISOString());
                                setLastImportDate(new Date().toISOString());
                                showToast('Backup restaurado: ' + data.trips.length + ' viajes', 'success');
                            },
                            true
                        );
                    } catch (err) {
                        showToast('Error al leer el archivo JSON', 'error');
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const handleClearAllData = () => {
                showConfirm(
                    'Borrar Todos los Datos',
                    'Se eliminaran TODOS los viajes y tu perfil. Esta accion no se puede deshacer. Te recomendamos exportar un backup antes.',
                    () => {
                        setTrips([]);
                        setProfile(null);
                        setHomeCoords(null);
                        localStorage.removeItem('nomadAtlasTrips');
                        localStorage.removeItem('nomadAtlasProfile');
                        localStorage.removeItem('nomadAtlasLastImport');
                        setLastImportDate(null);
                        setActiveTab('settings');
                        showToast('Todos los datos han sido eliminados', 'warning');
                    },
                    true
                );
            };

            const allPeople = [...new Map(trips.flatMap(t => t.personas).map(p => [p.nombre, p])).values()];
            const allDestinations = [...new Map(trips.flatMap(t => t.destinos).map(d => [d.lugar, { lugar: d.lugar, coordinates: d.coordinates }])).values()];
            const availableYears = [...new Set(trips.map(t => new Date(t.fechaInicio).getFullYear()))].sort((a, b) => b - a);
            const filteredTrips = selectedYear === 'all' ? trips : trips.filter(t => new Date(t.fechaInicio).getFullYear() === parseInt(selectedYear));

            return (
                <div className="app-container">
                    <header className="header">
                        <div className="header-content">
                            <h1 className="logo">Nomad Atlas</h1>
                            <nav className="nav-tabs">
                                <button className={`nav-tab ${activeTab === 'map' ? 'active' : ''}`} onClick={() => setActiveTab('map')} disabled={!profile}>üó∫Ô∏è Mapa</button>
                                <button className={`nav-tab ${activeTab === 'trips' ? 'active' : ''}`} onClick={() => setActiveTab('trips')} disabled={!profile}>‚úàÔ∏è Viajes{filteredTrips.length > 0 ? ' (' + filteredTrips.length + ')' : ''}</button>
                                <button className={`nav-tab ${activeTab === 'timeline' ? 'active' : ''}`} onClick={() => setActiveTab('timeline')} disabled={!profile}>üìÖ Timeline</button>
                                <button className={`nav-tab ${activeTab === 'dashboard' ? 'active' : ''}`} onClick={() => setActiveTab('dashboard')} disabled={!profile}>üìä Dashboard</button>
                                <button className={`nav-tab ${activeTab === 'wrapped' ? 'active' : ''}`} onClick={() => setActiveTab('wrapped')} disabled={!profile}>üéÅ Wrapped</button>
                                <button className={`nav-tab ${activeTab === 'settings' ? 'active' : ''}`} onClick={() => setActiveTab('settings')}>‚öôÔ∏è Ajustes</button>
                            </nav>
                        </div>
                    </header>

                    <main className="main-content">
                        {profile && availableYears.length > 0 && (
                            <div className="year-selector-bar">
                                <span style={{fontWeight: '700', color: 'var(--secondary)', fontSize: '0.9rem'}}>üìÖ A√±o:</span>
                                <button className={`year-chip ${selectedYear === 'all' ? 'active' : ''}`} onClick={() => setSelectedYear('all')}>Todos</button>
                                {availableYears.map(y => (
                                    <button key={y} className={`year-chip ${selectedYear === String(y) ? 'active' : ''}`} onClick={() => setSelectedYear(String(y))}>{y}</button>
                                ))}
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <>
                                <ProfileView profile={profile} onUpdateProfile={handleUpdateProfile} />
                                {profile && <DataManagementPanel trips={trips} lastImportDate={lastImportDate} onExportJSON={handleExportJSON} onExportCSV={handleExportCSV} onImportJSON={handleImportJSON} onClearAll={handleClearAllData} />}
                            </>
                        )}

                        {activeTab === 'map' && profile && (
                            <div className="map-container"><MapView trips={filteredTrips} homeCoords={homeCoords} onTripClick={setSelectedTrip} /></div>
                        )}

                        {activeTab === 'trips' && profile && (
                            <>
                                <div style={{display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap'}}>
                                    <button className="btn-primary" onClick={() => { setEditingTrip(null); setShowAddForm(!showAddForm); }}>
                                        {showAddForm ? '‚úï Cerrar Formulario' : '‚ûï Nuevo Viaje'}
                                    </button>
                                </div>
                                {(showAddForm || editingTrip) && (
                                    <AddTripForm onAddTrip={(trip) => { handleAddTrip(trip); setShowAddForm(false); }} allPeople={allPeople} allDestinations={allDestinations} editingTrip={editingTrip} onCancelEdit={() => { setEditingTrip(null); setShowAddForm(false); }} existingTrips={trips} showToast={showToast} onImportTrips={handleImportTrips} />
                                )}
                                <TripsListView trips={filteredTrips} onTripClick={setSelectedTrip} onEditTrip={(trip) => { handleEditTrip(trip); setShowAddForm(true); }} onDeleteTrip={handleDeleteTrip} />
                            </>
                        )}

                        {activeTab === 'timeline' && profile && <TimelineView trips={filteredTrips} onTripClick={setSelectedTrip} />}

                        {activeTab === 'dashboard' && profile && <DashboardView trips={filteredTrips} homeCoords={homeCoords} />}

                        {activeTab === 'wrapped' && profile && (
                            <WrappedView trips={filteredTrips} selectedYear={selectedYear} />
                        )}
                    </main>

                    {selectedTrip && <TripDetailModal trip={selectedTrip} onClose={() => setSelectedTrip(null)} homeCoords={homeCoords} onDelete={handleDeleteTrip} onEdit={handleEditTrip} />}
                    <ConfirmDialog {...confirmDialog} onCancel={() => setConfirmDialog(d => ({...d, isOpen: false}))} />
                    <ToastContainer toasts={toasts} />
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
